language: none

env:
  global:
    - secure: dQZVRqwghxcxtXs8ZVhwfqWR4KqY19bVDa0OUhO5dyovfoRY7nZnOWcOTwWM+pt+FmxK59PSypJLSsj4LzovZAZSi/vpuk8r4quZ2FB9kpH1RQ4D/AgI5sfuvMlGepVoitx6YtQYFSSFGCS01G/shtKZ3ZwaLrI1PscCYwOm6w8ew+cEPts14zCbaFo7O7NZZHEDnatpnkM2ujdrkRXEzktBRee+0hftiHWtPI3GEm9AGk3es+ldfZ1SdO5QkcOG2lPZ56VBM+kyqjr3wVNQU2TN/DqQR/ZItzWVPTHrLmgopU5xuPjlIHz46UV18N178HAHFF3e62tDeQ5X/V/Isw==

build:
  ci:
    - export DOCKER_IMAGE_NAME=ykrevnyi/retryer.js
    - if [ "$IS_RELEASE" == false ]; then export DOCKER_TAG=trunk-${COMMIT:0:7}; fi
    - if [ "$IS_RELEASE" == true ]; then export DOCKER_TAG=${GIT_TAG_NAME#v}; fi
    - ./ci/build.sh
    - ./ci/test.sh

  post_ci:
    - ./ci/publish.sh

integrations:
  hub:
    - integrationName: personal_dockerhub
      type: docker

  notifications:
    - integrationName: trigger.retryerjs.pipelines
      type: webhook
      payload:
        - versionName=${DOCKER_TAG#v}
        - isRelease=$IS_RELEASE
        - dockerImage=$DOCKER_IMAGE_NAME:$DOCKER_TAG
      on_success: always
      on_failure: never

branches:
  only:
    - master
    - v*
