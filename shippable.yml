language: none

env:
  global:
    - secure: W+NawTMpMcDOx2gcsGXso1Xo0t/iYRPwHekSAJBDionN0XLFvneZh073s3iE/+DXhgwxaZD30yUUqp/bk38n6f+yyrEWNBmnAa22527nn19V9mVtGSZxIOuTplaAfJQkLeOaIfVK5tJG7fJY35LD9PZZI4CE4/bs+MdSeZoDqnufZ0tuYb1Wo8YIIkJWTvwsRxu1HIsCunqiIG+E/fv8GJOK2VUIR2T8MNPAdrYWPPu7qhdizFDNxEmMLyQzBJWuVm1DNrUU+u3YOp6oaMHug78G3wNFiCpj0MkuLSYlx6v503/NUU5A1ulDNjWczAj5QcGfyochx7cILasM8VMXLw==

build:
  ci:
    - export DOCKER_IMAGE_NAME=ykrevnyi/retryer.js
    - if [ "$IS_RELEASE" == false ]; then export DOCKER_TAG=trunk-${COMMIT:0:7}; fi
    - if [ "$IS_RELEASE" == true ]; then export DOCKER_TAG=${GIT_TAG_NAME#v}; fi
    - ./ci/build.sh
    - ./ci/test.sh

  post_ci:
    - ./ci/publish.sh

integrations:
  hub:
    - integrationName: personal_dockerhub
      type: docker

  notifications:
    - integrationName: trigger.retryerjs.pipelines
      type: webhook
      payload:
        - versionName=${DOCKER_TAG#v}
        - isRelease=$IS_RELEASE
        - dockerImage=$DOCKER_IMAGE_NAME:$DOCKER_TAG
      on_success: always
      on_failure: never

branches:
  only:
    - master
    - v*
