language: none

env:
  - secure: KHroXnCDFg7grXzyspYL33EKy7i+K4XHGWyZoqnj2LBstbdZUTJIrez/HjgXaX7g4B2oStnY32qEeTHP6etaib9BC55XDXkrbmTm3aqnO+FANQcJuPz1anR3T4qxQbbiSqslAyTzuK+Azm3WRVIVoYkxpzUm1fQM/CR3ViHUWibk+nwos+Y6HNzT25RYA+Nh1KS/IUsf2j5VZVY+mWC5YA6r0GTvPpwk9kiC3M+ThSmCCzPl9aKqztN/k3FQUYu8UeOo3jnQ6QNbA4Xxa3O7641PufOiXDCUq2eUjcIg8Nn6E+5t3hng5nbL/fuujWVhNhX4Jyze95B2b3KrDTimsw==
  - NPM_EMAIL=ykrevnyi@gmail.com

build:
  ci:
    - export DOCKER_IMAGE_NAME=ykrevnyi/retryer.js
    - if [ "$IS_RELEASE" == false ]; then export DOCKER_TAG=trunk-${COMMIT:0:7}; fi
    - if [ "$IS_RELEASE" == true ]; then export DOCKER_TAG=${GIT_TAG_NAME#v}; fi
    - ./ci/build.sh
    - ./ci/test.sh

  post_ci:
    - echo $NPM_TOKEN > ~/.npmrc
    - ./ci/publish.sh

integrations:
  hub:
    - integrationName: personal_dockerhub
      type: docker

  notifications:
    - integrationName: trigger.retryerjs.pipelines
      type: webhook
      payload:
        - versionName=${DOCKER_TAG#v}
        - isRelease=$IS_RELEASE
        - dockerImage=$DOCKER_IMAGE_NAME:$DOCKER_TAG
      on_success: always
      on_failure: never

branches:
  only:
    - master
    - v*
