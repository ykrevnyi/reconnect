language: none

env:
  - secure: lRaHN0eO8x4zlqrsbhJRA9vfpL7EVlYiUYUQUKeGVvME2HP+vlHq8dySCxnjbdq3OpXM3sIFyiv78Wo/lDALiQn1fzPm40yrbEYTNZJ9LKYebUzg2ReCDFvbLu+q38tuNoDqH80y++e/rJTlKUooos0LOPd/zl4xTVs4z32Ol60xjLE46jIksdgjHRpWcxYH3mrSwTBQASx69xufbBxeM3pFoIEJe9WfONX3sbgBBTeALH1L+VDxI8WT5XwqhSTECK/1Ozdq9EJ4sw4Y2MAoBzshaf7Pizoe7ZxfdurhlPlloNUrESVO3E0x8tU8vVnqxaCS5lmeYSuCzXqn2VeYyA==
  - NPM_EMAIL=ykrevnyi@gmail.com

build:
  ci:
    - export DOCKER_IMAGE_NAME=ykrevnyi/retryer.js
    - if [ "$IS_RELEASE" == false ]; then export DOCKER_TAG=trunk-${COMMIT:0:7}; fi
    - if [ "$IS_RELEASE" == true ]; then export DOCKER_TAG=${GIT_TAG_NAME#v}; fi
    - ./ci/build.sh
    - ./ci/test.sh

  post_ci:
    - echo $NPM_TOKEN > ~/.npmrc
    - ./ci/publish.sh

integrations:
  hub:
    - integrationName: personal_dockerhub
      type: docker

  notifications:
    - integrationName: trigger.retryerjs.pipelines
      type: webhook
      payload:
        - versionName=${DOCKER_TAG#v}
        - isRelease=$IS_RELEASE
        - dockerImage=$DOCKER_IMAGE_NAME:$DOCKER_TAG
      on_success: always
      on_failure: never

branches:
  only:
    - master
    - v*
